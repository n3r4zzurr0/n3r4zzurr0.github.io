<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.3/beautify.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/a11y-dark.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
	<script src="video-f.js"></script>
	<style>
	body {
		margin: 0;
		font-family: monospace;
	}
	input {
		font-family: monospace;
	}
	button, select, input[type=file], input[type=file]::file-selector-button {
		font-family: monospace;
		cursor: pointer;
	}
	pre {
		margin: 0;
	}
	.container {
		display: flex;
		justify-content: space-between;
		width: calc(100vw - 48px);
		max-width: 900px;
		margin: 30px auto 0;
	}
	.or {
		text-align: center;
		margin: 12px 0;
	}
	.mb-24 {
		margin-bottom: 24px;
	}
	.input-box {
		display: flex;
		margin-bottom: 12px;
	}
	.input-box .label {
		width: 120px;
	}
	.container .left {
		width: 390px;
	}
	.container .left .box {
		padding: 18px;
		background-color: #f6f6f6;
	}
	.title {
		font-weight: bold;
		margin-bottom: 18px;
	}
	#console {
		margin-bottom: 18px;
	}
	#extract {
		width: 100%;
		height: 30px;
		margin-top: 18px;
	}
	#thumbnails {
		height: 300px;
		overflow: auto;
	}
	.container .right {
		width: 480px;
		overflow-x: auto;
	}
	</style>
</head>
<body>
	<div class="container">
		<div class="left">
			<div class="box">
				<div class="input-box" style="margin:0">
					<div class="label">Choose Video</div>
					<div class="input"><input id="file-input" type="file" accept="video/x-matroska,video/mp4,video/webm,video/quicktime" /></div>
				</div>
			</div>
			<div class="or">or</div>
			<div class="box">
				<div class="input-box" style="margin:0">
					<div class="label">Video URL</div>
					<div class="input"><input id="url-input" type="text" /></div>
				</div>
			</div>
			<div class="mb-24"></div>
			<div class="title">Image Options</div>
			<div class="box">
				<div class="input-box">
					<div class="label">Width (px)</div>
					<div class="input"><input id="width-input" type="text" placeholder="128" /></div>
				</div>
				<div class="input-box">
					<div class="label">Height (px)</div>
					<div class="input"><input id="height-input" type="text" placeholder="auto" /></div>
				</div>
				<div class="input-box" style="margin:0">
					<div class="label">Format</div>
					<div class="input">
						<select id="format-input">
							<option selected>image/png</option>
							<option>image/jpg</option>
							<option>image/webp</option>
						</select>
					</div>
				</div>
			</div>
			<div class="mb-24"></div>
			<div class="title">Video Options</div>
			<div class="box">
				<div class="input-box">
					<div class="label">Start Time (s)</div>
					<div class="input"><input id="start-time-input" type="text" placeholder="0" /></div>
				</div>
				<div class="input-box">
					<div class="label">End Time (s)</div>
					<div class="input"><input id="end-time-input" type="text" placeholder="Video Duration" /></div>
				</div>
				<div class="input-box" style="margin:0">
					<div class="label">Count</div>
					<div class="input"><input id="count-input" type="text" placeholder="1" /></div>
				</div>
			</div>
			<div class="or">or</div>
			<div class="box">
				<div class="input-box" style="margin:0">
					<div class="label">Offsets (s)<br /><span style="font-size:12px;">(comma sep.)</span></div>
					<div class="input"><input id="offsets-input" type="text" placeholder="0,1,2" /></div>
				</div>
			</div>
			<button id="extract">Extract</button>
		</div>
		<div class="right">
			<pre><code class="language-js">var i = 1;console.log(i);</code></pre>
			<div class="title" style="margin-top:30px">Extracted Frames</div>
			<div id="console">...</div>
			<div id="thumbnails"></div>
		</div>
	</div>

	<script>
	const App = {
		options: {
			url: null,
			width: null,
			height: null,
			format: null,
			startTime: null,
			endTime: null,
			count: null,
			offsets: null,
			onLoad: () => { console.log('video loaded'); App.loaded() },
			onProgress: (framesExtracted, totalFrames) => { console.log(`${framesExtracted} of ${totalFrames} frames extracted`); App.progress(framesExtracted, totalFrames) }
		},
		start: function() {
			this.urlInput = document.getElementById('url-input');
			this.fileInput = document.getElementById('file-input');
			this.widthInput = document.getElementById('width-input');
			this.heightInput = document.getElementById('height-input');
			this.formatInput = document.getElementById('format-input');
			this.startTimeInput = document.getElementById('start-time-input');
			this.endTimeInput = document.getElementById('end-time-input');
			this.countInput = document.getElementById('count-input');
			this.offsetsInput = document.getElementById('offsets-input');
			this.extractBtn = document.getElementById('extract');
			this.console = document.getElementById('console');
			this.thumbnails = document.getElementById('thumbnails');
			this.code = document.getElementsByClassName('right')[0].getElementsByTagName('code')[0];

			this.writeCode();
			this.listen();
		},
		listen: function() {
			this.fileInput.oninput = (e) => {
				this.options.url = URL.createObjectURL(e.target.files[0]);
				this.writeCode();
			};
			this.urlInput.oninput = (e) => { this.writeInput('url', e.target.value); }
			this.widthInput.oninput = (e) => { this.writeInput('width', e.target.value); this.checkWidthHeight(); }
			this.heightInput.oninput = (e) => { this.writeInput('height', e.target.value); this.checkWidthHeight(); }
			this.formatInput.oninput = (e) => {
				this.options.format = e.target.value === 'image/png' ? null : e.target.value;
				this.writeCode();
			};
			this.startTimeInput.oninput = (e) => { this.writeInput('startTime', e.target.value); }
			this.endTimeInput.oninput = (e) => { this.writeInput('endTime', e.target.value); }
			this.countInput.oninput = (e) => { this.writeInput('count', e.target.value); }
			this.offsetsInput.oninput = (e) => { 
				if(e.target.value)
					this.options.offsets = e.target.value.split(',');
				else
					this.options.offsets = null;
				this.writeCode();
			};
			this.extractBtn.onclick = () => { this.extract(); };
		},
		checkWidthHeight: function() {
			if(!this.options.width && this.options.height)
				this.widthInput.setAttribute('placeholder', 'auto');
			else
				this.widthInput.setAttribute('placeholder', '128');
		},
		writeInput: function(prop, value) {
			this.options[prop] = value;
			this.writeCode();
		},
		writeCode: function() {
			let code = '';
			code += 'videoFrames({';
			for(prop in this.options)
				if(this.options[prop]) {
					if(prop === 'url' || prop === 'format')
						code += `${prop}: '${this.options[prop].toString()}',`;
					else if(prop === 'offsets')
						code += `${prop}: [${this.options[prop].join(', ')}],`;
					else if(prop === 'onLoad')
						code += `${prop}: ${this.options[prop].toString().replace('; App.loaded()', '')},`;
					else if(prop === 'onProgress')
						code += `${prop}: ${this.options[prop].toString().replace('; App.progress(framesExtracted, totalFrames)', '')},`;
					else
						code += `${prop}: ${this.options[prop].toString()},`;
				}
			code += '}).then((frames) => { console.log(frames) })';
			this.code.innerHTML = js_beautify(code);
			hljs.highlightAll();
		},
		extract: function() {
			videoFrames({...this.options}).then((frames) => {
				console.log(frames);
				if(frames.length > 0) {
					this.thumbnails.innerHTML = '';
					frames.forEach(f => {
						this.thumbnails.innerHTML += `<img src="${f.image}" />`;
					});
				} else
					this.console.innerHTML = 'error (check console)';
			});
		},
		loaded: function() {
			this.console.innerHTML = `video loaded`;
		},
		progress: function(f, t) {
			this.console.innerHTML = `${f} of ${t} frames extracted`;
		}
	};
	window.onload = () => {
		App.start();
	};
	</script>
</body>
</html>
